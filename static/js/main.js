var message = ""
var submessage = ""
var pageLanguage = document.querySelector("html").lang;
var chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];

function updateChatHistory(newMessage) {
  chatHistory.push(newMessage);
  localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
}

var warningMessages = {
  "noinput": {
    "en": "Please enter some text",
    "zh-CN": "ËØ∑ËæìÂÖ•‰∏Ä‰∫õÊñáÊú¨",
    "ja": "„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
  },
  "longinput": {
    "en": "Input text is too long, please keep it under 512 characters",
    "zh-CN": "ËæìÂÖ•ÊñáÊú¨Â§™ÈïøÔºåËØ∑‰øùÊåÅÂú®512‰∏™Â≠óÁ¨¶‰ª•‰∏ã",
    "ja": "ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„ÅåÈï∑„Åô„Åé„Åæ„Åô„ÄÇ512ÊñáÂ≠ó‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
  },
  "nomodel": {
    "en": "Please select a model",
    "zh-CN": "ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ê®°Âûã",
    "ja": "„É¢„Éá„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
  },
  "generating": {
    "en": "Your response will be ready in a few seconds...",
    "zh-CN": "ÊÇ®ÁöÑÂõûÁ≠îÂ∞ÜÂú®Âá†ÁßíÈíüÂÜÖÂáÜÂ§áÂ•Ω...",
    "ja": "ÂõûÁ≠î„ÅØÊï∞Áßí„ÅßÊ∫ñÂÇô„Åï„Çå„Åæ„Åô..."
  },
  "rag_generating": {
    "en": "Collecting information from the Internet,\nthis may take a about 5 seconds...",
    "zh-CN": "Ê≠£Âú®ËÅîÁΩëÊî∂ÈõÜ‰ø°ÊÅØÔºå\nËøôÂèØËÉΩÈúÄË¶ÅÂ§ßÁ∫¶5Áßí...",
    "ja": "„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà„Åã„ÇâÊÉÖÂ†±„ÇíÂèéÈõÜ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÅ\nÁ¥Ñ5Áßí„Åã„Åã„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô..."
  },
  "noresponse": {
    "en": "No response from the server, please try again later",
    "zh-CN": "ÊúçÂä°Âô®Êú™ÂìçÂ∫îÔºåËØ∑Á®çÂêéÈáçËØï",
    "ja": "„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠î„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÅÂæå„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ"
  }
};
document.addEventListener("DOMContentLoaded", function () {
  document.querySelector("form").onsubmit = function (e) {
    e.preventDefault();
    var startTime = Date.now();
    response.style.display = "none";
    var responseElement = document.querySelector(".response");
    var inputText = document.getElementById("input_text").value;
    if (
      !inputText
    ) {
      responseElement.textContent = warningMessages["noinput"][pageLanguage];
      responseElement.style.display = "block";
      return;
    }
    if (inputText.length > 512) {
      responseElement.textContent = warningMessages["longinput"][pageLanguage];
      responseElement.style.display = "block";
      return;
    }
    if (!document.querySelector('input[name="model"]:checked')) {
      responseElement.textContent = warningMessages["nomodel"][pageLanguage];
      responseElement.style.display = "block";
      return;
    }

    var model = document.querySelector(
      'input[name="model"]:checked'
    ).value;

    var enableContext = document.getElementById("enabled_context").checked;
    var enableRag = document.getElementById("enabled_rag").checked;

    if (!enableContext) {
      chatHistory = [];
    } else {
      if (chatHistory.length > 8) {
        chatHistory = chatHistory.slice(chatHistory.length - 8);
      }
    }

    var slowGenerating = setTimeout(function () {
      responseElement.textContent = enableRag ? warningMessages["rag_generating"][pageLanguage] : warningMessages["generating"][pageLanguage];
      responseElement.style.display = "block";
    }, 2000);

    var NoResponseTimeout = setTimeout(function () {
      responseElement.textContent = warningMessages["noresponse"][pageLanguage];
      responseElement.style.display = "block";
    }, 30000);

    fetch("/generate", {
      method: "POST",
      body: new URLSearchParams({ input_text: inputText, model: model, context: JSON.stringify(chatHistory), rag: enableRag }),
      headers: {
        "Content-Type": "application/x-www-form-urlencoded",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        clearTimeout(slowGenerating);
        clearTimeout(NoResponseTimeout);
        var endTime = Date.now();
        var duration = endTime - startTime;
        var responseElement = document.querySelector(".response");
        responseElement.style.display = "block  ";
        if (data.error) {
          responseElement.textContent =
            "Error Occured in Frontend, Error Code: 401";
        } else {
          message = data.response;
          submessage = `<div class='submessage'>Our AI is ready in ${duration} ms‚ö°Ô∏è</div>`;
          responseElement.innerHTML = submessage + "<br><br>" + message;
          if (enableContext && !message.startsWith("Error")) {
            updateChatHistory({ "role": "user", "content": inputText });
            updateChatHistory({ "role": "assistant", "content": message });
          }
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        clearTimeout(slowGenerating);
        clearTimeout(NoResponseTimeout);
      });
  };

  document.querySelector(".response").onclick = function (event) {
    if (message == ""){ return; }
    if (event.target.tagName.toLowerCase() !== 'code') {
      submessage = "<div class='submessage'>Generated by AI, use in caution ü§ñ</div>";
      document.querySelector(".response").innerHTML = submessage + "<br><br>" + message;
      return;
    }
    const codeContent = event.target.innerText;
    navigator.clipboard.writeText(codeContent).then(function () {
      submessage = "<div class='submessage'>Code has been Copied ‚úÖ</div>";
      document.querySelector(".response").innerHTML = submessage + "<br><br>" + message;
    }).catch(function (error) {
      console.error("Copy Error: ", error);
    });
  };
});